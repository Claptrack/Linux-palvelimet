# h4) Maailma kuulee

## Pilven vuokraaminen ja virtuaalikoneen asennus pilveen

Päädyin käyttämään Microsoft Azuren palveluita, koska sinne pystyi kirjautumaan koulun sähköpostilla ja saamaan education-edut suoraan ilman Githubia välikätenä (minulla on Github Education aktiivisena, mutta DigitalOcean laittoi tilin lukkoon heti kirjautumisen yhteydessä ja Azuren education-etujen aktivoimiseen tarkoitettu linkki Githubin education-sivulla ei toiminut...).

Azure tarjoaa ison liudan palveluita opiskelijoille ilmaiseksi, mutta tätä tehtävää varten valitsin "Linux Virtual Machine".

<img width="1680" alt="image" src="https://github.com/user-attachments/assets/655b4d71-fe99-4c99-97fd-717dc85434db">

Annoin virtuaalikoneelle nimen, valitsin lähimmän mahdollisen alueen, jotta latenssi olisi mahdollisimman pieni, sekä valitsin käyttöjärjestelmäksi Debian 11:n.

<img width="775" alt="image" src="https://github.com/user-attachments/assets/4960f03a-0115-49c9-9640-f46dfb01f7fc">

Valitsin itselleni käyttäjätunnuksen, salasanan ja mitkä portit avataan ulkopuoliselle liikenteelle (tämä ei vielä avaa koneelle asennettavan palomuurin portteja).

![image](https://github.com/user-attachments/assets/72cba5a9-0f7d-42d5-87fa-898674bff059)

Ennen vahvistamista palvelu varoitti minua porttien avaamisesta, mutta tulin siihen tulokseen, että ainakin portti 22 on pidettävä auki, jotta saan virtuaalikoneeseen etäyhteyden. Päätin mennä takaisin alkuun ja valitsin ainoastaan portin 22 etäyhteyden saamiseksi. Menin sen jälkeen viimeiseen vaiheeseen ja painoin "Create".

Tämän jälkeen pääsin omalle hallintasivulleni ja odotettuani minuutin verran, käyttöjärjestelmä oli asennettu pilviympäristöön. Skippasin tässä vaiheessa suositellut asetukset ja klikkasin "Go to resource".

![image](https://github.com/user-attachments/assets/5cfd3ccd-352b-4aba-93eb-75073437639e)

Tämän jälkeen pääsin virtuaalikoneen hallintasivulle. Koko prosessissa meni arviolta 20 minuuttia ml. opiskelijaetujen aktivoiminen Azuren sivuilla.

![image](https://github.com/user-attachments/assets/0e1b4db9-aaf9-4b64-bc86-57027422d565)

Hallintasivulta näin VM:n (Virtual machine) julkisen IP-osoitteen, joten kokeilin oman koneeni komentoriviltä ottaa etäyhteyden komennolla 'ssh 13.79.34.101'. Vastasin "yes" ja syötin salasanan, jonka jälkeen pääsin sisään virtuaalikoneelleni. ***Tässä en siis kirajutunut root-käyttäjällä, vaan käyttäjällä, jonka loin Azuressa virtuaalikoneen asennuksen yhteydessä***.

<img width="913" alt="image" src="https://github.com/user-attachments/assets/27d6e3bb-3306-4aa7-a7bb-5568334cc527">

Tämän jälkeen tein tehtävänannossa mainitut toimenpiteet. Päätin ensin asentaa palomuurin.

'sudo apt-get update'

'sudo apt-get install ufw'

'sudo ufw allow 22/tcp'

'sudo ufw allow 80'

'sudo ufw enable'

Tarkistin tämän jälkeen komennolla 'sudo ufw status', että palomuuri on aktiivinen ja että oikeat portit ovat auki.

<img width="389" alt="image" src="https://github.com/user-attachments/assets/ba2e51b9-86be-44eb-a15c-ae04b8bca510">

Otin yhteyden virtuaalikoneeseen luomallani käyttäjällä, joten siirryin heti sulkemaan root-käyttäjän Teron [ohjeiden](https://terokarvinen.com/2017/first-steps-on-a-new-virtual-private-server-an-example-on-digitalocean/) mukaisesti.

'sudo usermod --lock root'

'sudoedit /etc/ssh/sshd_config'

Muutin seuraavan kohdan asetustiedostossa:

#PermitRootLogin prohibit-password --> PermitRootLogin no

<img width="158" alt="image" src="https://github.com/user-attachments/assets/44fcd3c1-1095-473c-9b25-cab3af015b4d">

Tämän jälkeen päivitin vielä ohjelmat

'sudo apt-get update'

'sudo apt-get upgrade'

Päivittämisen jälkeen käynnistin virtuaalikoneen uudelleen komennolla 'sudo reboot now' ja kirjauduin sisään uudella käyttäjällä.

## Weppipalvelimen asennus virtuaalikoneelle

Käytin tässä tehtävässä lähteenä omaa [raporttiani](https://github.com/Claptrack/Linux-palvelimet/blob/main/h3.md#c--name-based-virtual-host) edellisestä kotitehtävästä.

**Raportissa on tässä vaiheessa iso aukko** - asensin apachen ja tein tarvittavat toimenpiteet, mutta en kuitenkaan saanut sivua näkymään verkon ulkopuolella. Tein toisen virtuaalikoneen, koska epäilin tehneeni jotain väärin, tai vähintäänkin paljon ylimääräistä, jota en jaksanut lähteä purkamaan. Lopulta tajusin itse palveluntarjoajan (Azure) blokkaavan portin 80, joka esti sivustolle pääsyn VM:n ulkopuolelta. Muutin asetukset ja aloitin alusta. Tein uudestaan stepit uuden virtuaalikoneen asentamiseksi.

### Uusi yritys virtuaalikoneen uudelleenasennuksen jälkeen

Asensin apachen:

'sudo apt-get update, sudo apt-get install apache2'

Korvasin apachen testisivun komennolla

'echo "Heipat!"|sudo tee /var/www/html/index.html

Kokeilin toisella koneella ottaa yhteyttä weppipalvelimeen osoitteella http://20.82.182.227

<img width="1183" alt="image" src="https://github.com/user-attachments/assets/8464ec7b-49da-4c91-ba5d-3eb719431064">

[Askubuntussa](https://askubuntu.com/questions/767504/permissions-problems-with-var-www-html-and-my-own-home-directory-for-a-website) oli keskustelua oman kotihakemiston julkaisemista ja sen "vaaroista", joten päätin laittaa weppisivuni /var/www-hakemistoon. Lisäsin hakemistoon toisella kurssilla tekemäni weppisivun pienin muutoksin, ja voilá:

![image](https://github.com/user-attachments/assets/17301dcf-97f5-4fd9-8266-9fa519a08d5c)

<img width="1186" alt="image" src="https://github.com/user-attachments/assets/203d7260-3f1f-49de-b3dd-94395ed2f414">

# Lähteet

Tehtävänanto: https://terokarvinen.com/linux-palvelimet/#h4-maailma-kuulee

First Steps on a New Virtual Private Server, Tero Karvinen: https://terokarvinen.com/2017/first-steps-on-a-new-virtual-private-server-an-example-on-digitalocean/

